<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Image Processor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- Image Upload Section -->
<div class="container mt-5">
    <h1 class="mb-4">Image Processor</h1>
    <div class="mb-3">
        <label for="imageUpload" class="form-label">Upload an image</label>
        <input type="file" class="form-control" id="imageUpload">
    </div>

    <!-- Checkbox table for Lego colors -->
    <h5>Select Lego Colors:</h5>
    <div>
        <label>
            <button id="checkAll"> Check All</button>
        </label>
        <label>
            <button id="uncheckAll"> Uncheck All</button>
        </label>
    </div>
    <div class="mb-3" id="legoColorsCheckboxes">
        <table>
            <tbody id="checkboxRow">
            <tr></tr>
            </tbody>
        </table>
    </div>

    <button class="btn btn-primary" onclick="processImage()">Process image</button>
</div>

<!-- Images Display Section -->
<div class="container mt-5 d-none" id="imageDisplaySection">
    <div class="row">
        <div class="col">
            <h2>Original Image</h2>
            <img id="originalImage" class="img-fluid" alt="Original Image">
        </div>
        <div class="col">
            <h2>Processed Image</h2>
            <img id="processedImage" class="img-fluid" alt="Processed Image">
        </div>
    </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<!-- Your JavaScript for Image Processing -->
<script src="lego-colors.js"></script>
<script>
    // Dynamically generate checkboxes for Lego colors in a table
    const checkboxRow = document.getElementById('checkboxRow');
    let cellCounter = 0;

    for (const color in legoColors) {
        if (cellCounter === 8) {
            cellCounter = 0;
            checkboxRow.appendChild(document.createElement('tr'));
        }

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = color;
        checkbox.id = color;
        checkbox.checked = true; // Default to checked

        const label = document.createElement('label');
        label.htmlFor = color;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(legoColors[color]));
        label.style.backgroundColor = '#' + color;
        label.style.width = '100%';

        const cell = document.createElement('td');
        cell.appendChild(label);

        checkboxRow.lastElementChild.appendChild(cell);

        cellCounter++;
    }

    // Gérer le clic sur la case à cocher "Check All"
    document.getElementById('checkAll').addEventListener('click', function () {
        const checkboxes = legoColorsCheckboxes.getElementsByTagName('input');
        for (const checkbox of checkboxes) {
            checkbox.checked = true;
        }
    });

    // Gérer le clic sur la case à cocher "Uncheck All"
    document.getElementById('uncheckAll').addEventListener('click', function () {
        const checkboxes = legoColorsCheckboxes.getElementsByTagName('input');
        for (const checkbox of checkboxes) {
            checkbox.checked = false;
        }
    });

    function processImage() {
        const imageUpload = document.getElementById('imageUpload');
        const originalImage = document.getElementById('originalImage');
        const processedImage = document.getElementById('processedImage');
        const imageDisplaySection = document.getElementById('imageDisplaySection');

        // Get selected Lego colors
        const selectedColors = Array.from(legoColorsCheckboxes.getElementsByTagName('input'))
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        // Check if an image is selected
        if (imageUpload.files.length > 0) {
            const reader = new FileReader();

            // Read the selected image
            reader.onload = function (e) {
                const img = new Image();
                img.src = e.target.result;

                img.onload = function () {
                    // Display original image
                    originalImage.src = img.src;

                    // Process the image and display the processed image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    const pixels = imageData.data;

                    for (let i = 0; i < pixels.length; i += 4) {
                        const closestColor = findClosestColor(pixels[i], pixels[i + 1], pixels[i + 2], selectedColors);
                        pixels[i] = closestColor.red;
                        pixels[i + 1] = closestColor.green;
                        pixels[i + 2] = closestColor.blue;
                    }

                    ctx.putImageData(imageData, 0, 0);
                    processedImage.src = canvas.toDataURL('image/png');

                    // Show the image display section
                    imageDisplaySection.classList.remove('d-none');

                    // Store the used colors in an array
                    const usedColors = [];

                    for (let i = 0; i < pixels.length; i += 4) {
                        const closestColor = findClosestColor(pixels[i], pixels[i + 1], pixels[i + 2], selectedColors);
                        pixels[i] = closestColor.red;
                        pixels[i + 1] = closestColor.green;
                        pixels[i + 2] = closestColor.blue;

                        // Ajouter la couleur la plus proche utilisée à la liste
                        const usedColor = rgbToHex(closestColor.red, closestColor.green, closestColor.blue);
                        if (!usedColors.includes(usedColor)) {
                            usedColors.push(usedColor);
                        }
                    }

                    console.log(usedColors);

                    // Mettre à jour la visibilité des cases à cocher après le traitement de l'image
                    updateCheckboxVisibility(usedColors);
                };
            };

            reader.readAsDataURL(imageUpload.files[0]);
        } else {
            alert('Please select an image.');
        }
    }

    function findClosestColor(red, green, blue, selectedColors) {
        let closestColor = { distance: Infinity };

        for (const color of selectedColors) {
            const [targetRed, targetGreen, targetBlue] = hexToRgb(color);

            const distance = Math.sqrt(
                Math.pow(targetRed - red, 2) +
                Math.pow(targetGreen - green, 2) +
                Math.pow(targetBlue - blue, 2)
            );

            if (distance < closestColor.distance) {
                closestColor = {
                    distance: distance,
                    red: targetRed,
                    green: targetGreen,
                    blue: targetBlue,
                };
            }
        }

        return closestColor;
    }

    function hexToRgb(hex) {
        // Remove the hash sign if present
        hex = hex.replace(/^#/, '');

        // Parse the hex values
        const bigint = parseInt(hex, 16);

        // Extract RGB values
        const red = (bigint >> 16) & 255;
        const green = (bigint >> 8) & 255;
        const blue = bigint & 255;

        return [red, green, blue];
    }

    function rgbToHex(red, green, blue) {
        // Convertir les valeurs RGB en hexadécimal
        const hex = (red << 16 | green << 8 | blue).toString(16);
        // Remplir de zéros à gauche si nécessaire
        const paddedHex = '000000'.slice(0, 6 - hex.length) + hex;
        // Convertir en majuscules et retourner la chaîne hexadécimale
        return paddedHex.toUpperCase();
    }

    function updateCheckboxVisibility(usedColors) {
        const checkboxes = legoColorsCheckboxes.getElementsByTagName('input');

        for (const checkbox of checkboxes) {
            const color = checkbox.value;

            // Vérifier si la couleur a été utilisée dans l'image générée
            checkbox.checked = (usedColors.includes(color));
        }
    }
</script>

</body>
</html>
